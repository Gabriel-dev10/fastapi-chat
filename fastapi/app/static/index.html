<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App Moderno</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      header {
        background: rgba(255, 255, 255, 0.95);
        padding: 15px 20px;
        text-align: center;
        font-size: 20px;
        font-weight: 600;
        color: #4a5568;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      
      .header-icon {
        font-size: 14px;
      }
      
      .container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        gap: 20px;
        width: 100%;
      }
      
      .settings {
        display: flex;
        gap: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        height: auto;
      }
      
      .settings input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
        color: #333;
        outline: none;
        transition: all 0.3s;
      }
      
      .settings input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .settings button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        background: #667eea;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
      }
      
      .settings button:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }
      
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      
      .chat-header {
        background: #fff;
        padding: 15px 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .chat-title {
        font-weight: 600;
        color: #4a5568;
        font-size: 16px;
      }
      
      .user-count {
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }
      
      #messages {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 20px;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 transparent;
      }
      
      #messages::-webkit-scrollbar {
        width: 6px;
      }
      
      #messages::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 10px;
      }
      
      .message {
        display: flex;
        flex-direction: column;
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 16px;
        background: #f7fafc;
        color: #2d3748;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        position: relative;
      }
      
      .message.own {
        align-self: flex-end;
        background: #667eea;
        color: white;
      }
      
      .message-meta {
        font-size: 11px;
        margin-bottom: 5px;
        opacity: 0.7;
        font-weight: 500;
      }
      
      .message.own .message-meta {
        text-align: right;
      }
      
      .message-bubble {
        line-height: 1.4;
      }
      
      .input-container {
        display: flex;
        gap: 10px;
        padding: 15px;
        background: #fff;
        border-top: 1px solid #e2e8f0;
      }
      
      .input-container input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e2e8f0;
        border-radius: 24px;
        font-size: 14px;
        background: #f7fafc;
        color: #333;
        outline: none;
        transition: all 0.3s;
      }
      
      .input-container input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .input-container button {
        padding: 12px 20px;
        border: none;
        border-radius: 24px;
        background: #667eea;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .input-container button:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }
      
      .connection-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        color: #718096;
      }
      
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #e53e3e;
      }
      
      .status-dot.connected {
        background: #38a169;
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 10px;
          gap: 15px;
        }
        
        .settings {
          flex-direction: column;
        }
        
        .message {
          max-width: 15%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <span class="header-icon">ðŸ’¬</span>
      Chat App
    </header>
    <div class="container">
      <div class="settings">
        <input id="room" placeholder="Nome da sala (ex: geral)" />
        <input id="username" placeholder="Seu nome de usuÃ¡rio" />
        <button id="connectBtn">Conectar</button>
      </div>
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-title">Clube: <span id="currentRoom">geral</span></div>
          <div class="connection-status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Desconectado</span>
          </div>
          <div class="user-count" id="userCount">0 online</div>
        </div>
        <div id="messages"></div>
        <div class="input-container">
          <input id="input" type="text" placeholder="Digite sua mensagem..." disabled />
          <button id="sendBtn" disabled>
            <span>Enviar</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script>
      const $room = document.getElementById("room");
      const $username = document.getElementById("username");
      const $messages = document.getElementById("messages");
      const $input = document.getElementById("input");
      const $connectBtn = document.getElementById("connectBtn");
      const $sendBtn = document.getElementById("sendBtn");
      const $currentRoom = document.getElementById("currentRoom");
      const $statusDot = document.getElementById("statusDot");
      const $statusText = document.getElementById("statusText");
      const $userCount = document.getElementById("userCount");

      $room.value = localStorage.getItem("room") || "geral";
      $username.value = localStorage.getItem("username") || "";

      let ws = null;
      let userCount = 0;

      function updateConnectionStatus(connected) {
        if (connected) {
          $statusDot.classList.add("connected");
          $statusText.textContent = "Conectado";
          $input.disabled = false;
          $sendBtn.disabled = false;
        } else {
          $statusDot.classList.remove("connected");
          $statusText.textContent = "Desconectado";
          $input.disabled = true;
          $sendBtn.disabled = true;
        }
      }

      function appendMessage(item) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        if (item.username === $username.value.trim()) {
          messageDiv.classList.add("own");
        }

        const metaDiv = document.createElement("div");
        metaDiv.className = "message-meta";
        const when = new Date(item.created_at).toLocaleTimeString();
        metaDiv.textContent = `${item.username} â€¢ ${when}`;

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "message-bubble";
        bubbleDiv.textContent = item.content;

        messageDiv.appendChild(metaDiv);
        messageDiv.appendChild(bubbleDiv);
        $messages.appendChild(messageDiv);
        $messages.scrollTop = $messages.scrollHeight;
      }

      function appendHistory(items) {
        $messages.innerHTML = "";
        items.forEach(appendMessage);
      }

      function connect() {
        const room = ($room.value || "geral").trim();
        const username = ($username.value || "anon").trim();
        if (!room) return alert("Informe a sala");
        if (!username) return alert("Informe o nome");

        localStorage.setItem("room", room);
        localStorage.setItem("username", username);
        
        $currentRoom.textContent = room;

        const wsProto = location.protocol === "https:" ? "wss" : "ws";
        const url = `${wsProto}://${location.host}/ws/${encodeURIComponent(
          room
        )}`;
        ws = new WebSocket(url);

        ws.onmessage = (evt) => {
          const data = JSON.parse(evt.data);
          if (data.type === "history") {
            appendHistory(data.items || []);
          } else if (data.type === "message") {
            appendMessage(data.item);
          } else if (data.type === "userCount") {
            userCount = data.count;
            $userCount.textContent = `${userCount} online`;
          }
        };

        ws.onopen = () => {
          console.log("WS conectado");
          updateConnectionStatus(true);
        };
        
        ws.onclose = () => {
          console.log("WS desconectado");
          updateConnectionStatus(false);
        };
        
        ws.onerror = (e) => {
          console.error("WS erro", e);
          updateConnectionStatus(false);
        };
      }

      $connectBtn.addEventListener("click", () => {
        if (ws) ws.close();
        connect();
      });

      function sendMessage() {
        const content = $input.value.trim();
        if (!content || !ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify({ content, username: $username.value }));
        $input.value = "";
      }

      $sendBtn.addEventListener("click", sendMessage);
      $input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // Inicializar status
      updateConnectionStatus(false);
    </script>
  </body>
</html>